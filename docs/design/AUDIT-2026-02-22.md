# cnos Codebase Audit — 2026-02-22

**Version:** 3.0.0
**Commit:** dc0879c (HEAD)
**Methodology:** Full static analysis of all source, tests, docs, CI/CD, specs, and release notes. TSC triadic grading applied per CLP self-check methodology.

---

## TSC Coherence Grade

| Axis | Grade | Score | Rationale |
|------|-------|-------|-----------|
| **alpha (PATTERN)** | A- | 0.85 | Strong structural consistency across modules. Clean layering (cli -> cmd -> lib/protocol/transport). Consistent naming conventions. Deductions: god module (cn_agent.ml, 731 lines), ~12% dead code (~600-700 lines), duplicated code across transport/lib layers, `log_action` no-op called everywhere, wrong weekly calculation, crontab replacement bug. |
| **beta (RELATION)** | B+ | 0.82 | Good pattern-relation alignment: FSMs match types, protocol spec matches code. Deductions: whitepaper says `peers.json` but code uses `peers.md`; ARCHITECTURE.md references non-existent `cn_daemon.ml`; SYSTEM.md vs AGENT.md contradict on agent interface; HUB.md vs SYSTEM.md directory mismatch; actor FSM disconnected from v3.0 runtime; CLI flags parsed but do nothing. |
| **gamma (EXIT/PROCESS)** | A- | 0.85 | Evolution is disciplined: 86 commits, clear version progression (v0.1 to v3.0), each release with coherent scope. CHANGELOG is detailed and version-stamped. CI enforces build+test. Deductions: no git tags, no release checksums, deprecated code retained without removal timeline, `cn_io.ml` superseded but not removed. |
| **C_Sigma** | **B+/A-** | **0.84** | `(0.85 * 0.82 * 0.85)^(1/3) = 0.840`. A mature, well-structured project with good internal coherence. The main bottleneck is beta (spec-code drift, dead abstractions, feature gaps in parsed-but-inactive flags). |

---

## 1. Code Audit

### 1.1 Metrics

| Metric | Value |
|--------|-------|
| Total OCaml source (`.ml`/`.mli`) | 22 files |
| Total source LOC | 5,850 |
| Total test LOC | 3,019 |
| Test-to-source ratio | 0.52:1 |
| Avg module size | 266 lines |
| Largest module | `cn_agent.ml` (731 lines) |
| Smallest module | `cn_fmt.ml` (47 lines) |
| Libraries defined | 6 (cn_lib, cn_cmd, cn_ffi, cn_protocol, cn_io, inbox_lib) |
| External deps at runtime | 0 (stdlib + Unix only) |
| Build system | dune 3.8 |

### 1.2 Architecture

The codebase follows a clean layered architecture:

```
cn.ml (CLI dispatch, 118 lines)
  -> cn_commands.ml (command routing, 141 lines)
  -> cn_runtime.ml (orchestrator, 557 lines)
  -> cn_agent.ml (queue + ops, 731 lines)
  -> cn_protocol.ml (4 typed FSMs, 270 lines)
  -> cn_lib.ml (pure core, 669 lines)
  -> cn_ffi.ml (system boundary, 176 lines)
```

**Strengths:**

- **Pure core library** (`cn_lib.ml`): All types, parsing, and help text are pure functions. Fully testable with ppx_expect, no mocking needed. This is textbook OCaml design.
- **Typed FSMs** (`cn_protocol.ml` + `.mli`): Four finite state machines (Thread, Actor, Sender, Receiver) with exhaustive pattern matching. Invalid transitions return `Error`, never exceptions. Terminal states are idempotent. The `.mli` interface file properly hides implementation.
- **Zero runtime dependencies**: Only stdlib + Unix. HTTP done via `curl` subprocess. This is a deliberate and defensible architectural choice for a system that runs on minimal VPS instances.
- **Consistent module doc headers**: Every `.ml` file opens with `(** module.ml — description *)` documenting purpose, layering, and design rationale.
- **Exhaustive variant types**: `command`, `agent_op`, `thread_state`, `actor_state`, `sender_state`, `receiver_state` all use OCaml variants with exhaustive matching. The compiler enforces completeness.
- **Atomic locking** (`cn_runtime.ml:30-52`): Uses `O_CREAT|O_EXCL` for exclusive lock with stale lock detection (10-minute threshold). Proper cleanup in `finally` blocks.

**Issues:**

1. **God module — `cn_agent.ml` (731 lines)**
   - Mixes queue FIFO, I/O paths, operation execution, archival, auto-update logic (lines 454-608, ~155 lines), and the deprecated `run_inbound` loop (lines 616-731).
   - The auto-update section alone (platform detection, binary download, verification, atomic replace, re-exec) is a distinct concern that warrants its own module.
   - `run_out` (lines 324-429) is 106 lines mixing file I/O, git operations, and JSON construction.
   - **Recommendation:** Extract `cn_update.ml` (~155 lines) and consider splitting `run_out` into smaller functions.

2. **Deprecated code still present (115 lines)**
   - `run_inbound` (lines 616-731): Marked deprecated, prints warning, but still callable.
   - `feed_next_input` (lines 262-286): Deprecated, replaced by `Cn_runtime.process_one`.
   - `wake_agent` (line 292): Deprecated, does nothing.
   - These are documented as "kept for one release cycle" — appropriate if there's a removal timeline, but no target version is specified.
   - **Recommendation:** Specify removal version (e.g., "Remove in v3.1.0") or remove now since v3.0.0 is the breaking change release.

3. **Re-exported functions for test access** (`cn_agent.ml:511-513`)
   ```ocaml
   let version_to_tuple = Cn_lib.version_to_tuple
   let is_newer_version = Cn_lib.is_newer_version
   ```
   Tests should import from `Cn_lib` directly. This is a mild code smell.

4. **Module-level side effects** (`cn_agent.ml:464-473`)
   - `install_dir` is computed at module load time using `Sys.file_exists` and `Sys.getenv_opt`. This runs during every `cn` invocation even when unused.
   - **Recommendation:** Make it a function `install_dir ()` with `lazy` evaluation.

5. **Shell command construction** (`cn_agent.ml:506, 538-540`)
   - Uses `Printf.sprintf` to build shell commands with `cd %s &&`. The `install_dir` value comes from environment variables, creating a potential injection vector if `CNOS_DIR` contains shell metacharacters.
   - The `run_out` function properly uses `Filename.quote` for the commit message (line 426), showing awareness of the issue, but `install_dir` interpolation is unquoted.
   - **Recommendation:** Use `Filename.quote` consistently for all paths interpolated into shell commands.

6. **Missing `string_of_sender_event` and `string_of_receiver_event`**
   - `cn_protocol.ml` defines `string_of_*_state` and `string_of_*_event` for Thread and Actor FSMs but only `string_of_*_state` for Sender and Receiver. The `.mli` mirrors this gap.
   - **Recommendation:** Add the missing stringifiers for debugging/logging consistency.

7. **`cn_json.ml` — custom JSON parser (310 lines)**
   - A hand-rolled recursive descent JSON parser. Correct for the subset of JSON used (Claude API responses, Telegram API). Handles strings, numbers, arrays, objects, booleans, null.
   - Does not handle unicode escape sequences (`\uXXXX`) — fine for current usage but would be an issue for internationalized Telegram usernames.
   - **Risk:** Low, since Telegram messages with unicode names would fail `parse_update` silently.

8. **`cn_ffi.ml` — missing error context** (`cn_ffi.ml:176 lines`)
   - `Child_process.exec` returns `Some string | None`, losing error details (exit code, stderr). This makes debugging auto-update failures or git operation failures harder.
   - **Recommendation:** Consider `(string, string) result` for critical paths.

### 1.3 Security Model

**Strengths:**
- LLM never touches files, commands, or network directly — pure `string -> string` function.
- Agent ops parsed from output.md frontmatter and validated before execution.
- Raw I/O pairs archived before effects (crash-safe audit trail).
- API keys via env vars, never logged.
- Atomic file locking prevents concurrent cron overlap.
- `allowed_users = []` defaults to deny-all for Telegram daemon.
- Branch ownership enforced: only creator deletes their branches (`cn_mail.ml`).
- Binary update verification: `--version` check before atomic replace.

**Concerns:**
- Shell injection surface via `install_dir` (see item 5 above).
- `Filename.quote` used inconsistently across modules.
- No TLS certificate pinning for curl calls to Claude/Telegram APIs (relies on system CA store — acceptable for most deployments).
- Auto-update downloads binaries over HTTPS from GitHub releases — supply-chain trust depends entirely on GitHub's infrastructure.

---

## 2. Test Audit

### 2.1 Metrics

| Metric | Value |
|--------|-------|
| Unit test files (ppx_expect) | 5 |
| Cram test files | 9 |
| Total test LOC | 3,019 |
| Unit test LOC | 2,410 |
| Cram test LOC | 609 |
| Test-to-source ratio | 0.52:1 |

### 2.2 Unit Tests (ppx_expect)

| Test file | LOC | What it tests |
|-----------|-----|---------------|
| `cn_cmd_test.ml` | 786 | 10 command modules: parsing, version comparison, config loading, telegram parsing, context scoring, daemon state predicates |
| `cn_protocol_test.ml` | 631 | All 4 FSMs: exhaustive transition tables, string roundtrips, path/meta derivation, edge cases |
| `inbox_test.ml` | 417 | Inbox materialization, dedup, rejection cleanup, branch filtering |
| `cn_json_test.ml` | 289 | JSON parser: strings, numbers, arrays, objects, nested structures, edge cases |
| `cn_test.ml` | 287 | Core library: command parsing, frontmatter, help text, version comparison, alias expansion |

**Strengths:**
- **Exhaustive FSM testing**: `cn_protocol_test.ml` tests every valid transition AND every invalid transition for all 4 FSMs. This is the gold standard for state machine testing.
- **ppx_expect snapshot testing**: All unit tests use snapshot assertions, making expected output explicit and changes visible in diffs.
- **Edge case coverage**: Tests include empty strings, missing fields, garbage input, unicode/emoji, boundary values, and idempotent operations.
- **Real filesystem fixtures**: `cn_cmd_test.ml` uses `with_temp_hub` helper that creates real temp directories with proper `Fun.protect` cleanup — no mocking.
- **Config tests**: Cover defaults, env overrides, integer clamping (0 and negative values), invalid JSON, missing keys.

**Gaps:**
1. **No tests for `cn_runtime.ml` integration** — The 557-line orchestrator has no dedicated test file. Its internal helpers (`extract_inbound_message`, `telegram_payload`) are tested via `cn_cmd_test.ml`, but the `process_one` and `run_cron` orchestration logic is only covered by cram tests.
2. **No tests for `cn_io.ml`** (192 lines) — The transport I/O module has no unit tests. It handles sync, outbox flush, and branch operations.
3. **No tests for `cn_mail.ml`** (453 lines) — The mail/sync module has no dedicated unit test file. Critical logic like `parse_rejected_branch` is tested in `cn_cmd_test.ml`, but branch ownership enforcement and sync logic are only covered by cram tests.
4. **No tests for `cn_system.ml`** (467 lines) — Hub initialization, doctor, status, setup, release logic untested at unit level.
5. **`parse_response` does not test `stop_reason` values** other than `end_turn` (e.g., `max_tokens`, `tool_use`).
6. **No concurrency tests** for the locking mechanism in `cn_runtime.ml`.
7. **Test coverage by module:**

| Module | LOC | Has unit tests? | Has cram tests? | Coverage assessment |
|--------|-----|----------------|-----------------|-------------------|
| `cn_lib.ml` | 669 | Yes | Yes | Good |
| `cn_agent.ml` | 731 | Partial | Yes | Moderate |
| `cn_runtime.ml` | 557 | Partial | Partial | Low-moderate |
| `cn_system.ml` | 467 | No | No | None |
| `cn_mail.ml` | 453 | Partial | Yes | Moderate |
| `cn_protocol.ml` | 270 | Yes (exhaustive) | Yes | Excellent |
| `cn_json.ml` | 310 | Yes | No | Good |
| `cn_gtd.ml` | 246 | No | No | None |
| `cn_io.ml` | 192 | No | Partial | Low |
| `cn_ffi.ml` | 176 | No | No | None (boundary) |
| `cn_context.ml` | 177 | Partial | No | Low |
| `cn_telegram.ml` | 170 | Partial | No | Low |
| `cn_llm.ml` | 154 | Partial | No | Low |
| `cn_mca.ml` | 158 | No | No | None |
| `cn_commands.ml` | 141 | No | Partial | Low |
| `cn_hub.ml` | 91 | No | No | None |
| `cn_config.ml` | 88 | Yes | No | Good |
| `cn_fmt.ml` | 47 | No | No | None (trivial) |
| `inbox_lib.ml` | 395 | Yes | Yes | Good |

### 2.3 Cram Tests

| Test file | LOC | What it tests |
|-----------|-----|---------------|
| `no-cross-delete.t` | 115 | Branch ownership: receiver never deletes sender branches |
| `send-protocol.t` | 86 | Full send lifecycle: outbox -> branch -> push -> deliver |
| `push-verify.t` | 87 | Push verification with content integrity |
| `agent-output.t` | 77 | Agent output (cn out) GTD protocol |
| `inbox-protocol.t` | 74 | Inbox materialization and dedup |
| `cli/cli.t` | 74 | CLI dispatch: help, version, status, doctor, error handling |
| `outbox.t` | 46 | Outbox listing and flush |
| `sync.t` | 29 | Sync command with no peers |
| `version.t` | 21 | Version string format |

**Strengths:**
- Cram tests provide end-to-end integration coverage using real git repos.
- `cn.sh` wrapper script properly bootstraps test environment.
- `no-cross-delete.t` is particularly well-designed — tests a critical security invariant (branch ownership) with realistic multi-agent setup.

**Gaps:**
- No cram tests for `cn agent` modes (cron, daemon, stdio).
- No cram tests for `cn init`, `cn setup`, `cn update`, `cn release`.
- No cram tests for GTD commands (`cn do`, `cn done`, `cn defer`, `cn delegate`, `cn delete`).

---

## 3. Documentation Audit

### 3.1 Metrics

| Metric | Value |
|--------|-------|
| Markdown files | 122 |
| Total doc LOC | ~15,885 |
| Doc-to-source ratio | 2.7:1 |
| Design docs | 11 active + 7 archived |
| How-to guides | 5 |
| Checklists | 5 |
| RCA reports | 7 |
| Agent skill definitions | ~50 SKILL.md files |

### 3.2 Structure

Documentation follows the Diataxis framework (tutorials, how-to, reference, explanation) with supplementary design documents, checklists, and RCA reports. This is a well-organized documentation system.

**Strengths:**
- **ARCHITECTURE.md** is an outstanding entry point: covers concepts, module structure, dependency layers, FSMs, data flow, directory layout, and transport protocol in a single coherent document.
- **WHITEPAPER.md** is academic-quality: normative protocol specification with RFC 2119 keywords, citations, and formal requirements in appendix.
- **PROTOCOL.md** provides ASCII FSM diagrams and transition tables that exactly match `cn_protocol.ml` types.
- **CHANGELOG.md** includes TSC coherence grades for every version — a unique quality signal.
- **7 RCA reports** with structured post-mortem format showing engineering maturity.
- **Diataxis framework** properly separates tutorials, how-to, reference, and explanation.
- **docs/README.md** provides a reading path index for different audiences.

### 3.3 Issues

1. **ARCHITECTURE.md references `cn_daemon.ml`** in the module reference table, but this module does not exist. The daemon functionality is integrated into `cn_runtime.ml`. This is a doc-code mismatch.

2. **WHITEPAPER.md says `peers.json`** (Section 10 implementation status marks it "Done"), but the codebase uses `state/peers.md` (Markdown format). The JSON schema exists at `spec/schemas/peers.schema.json` but is not used by the code.

3. **Version drift in WHITEPAPER.md**: The whitepaper is versioned "v2.0.4 RELEASE" but the codebase is at v3.0.0. The whitepaper has not been updated for the v3.0 pure-pipe architecture changes (no tool loop, context stuffing instead).

4. **ROADMAP.md is outdated**: Lists items that have been completed (e.g., "native agent runtime") without status updates. Some items reference OpenClaw which was removed in v3.0.0.

5. **PLAN.md is stale**: A 20K-character planning document that appears to be a snapshot from a specific planning session rather than a living document. Contains implementation details for v3.0 development that have since been completed.

6. **Skill files are numerous but inconsistently structured**: ~50 SKILL.md files across agent/, eng/, ops/, pm/ directories. Some are detailed with prerequisites, kata exercises, and anti-patterns; others are minimal placeholders.

7. **Missing tutorial content**: `docs/tutorials/DOJO.md` exists but is the only tutorial. For a project of this complexity, more hands-on tutorials would help onboarding.

8. **Archived docs not clearly labeled**: `docs/design/_archive/` contains 7 superseded documents but they don't have "SUPERSEDED" banners at the top — readers could find them via search and mistake them for current.

---

## 4. Release Notes Audit

### 4.1 CHANGELOG.md Quality

**Strengths:**
- Comprehensive entries for every major version from v0.1.0 to v3.0.0.
- Follows Keep-a-Changelog format: Added, Changed, Fixed, Breaking Changes, Migration sections.
- v3.0.0 entry includes architecture diagrams, token cost comparisons, module line counts, and security model summary — excellent for a major release.
- TSC coherence grades for every version provide a unique quality metric over time.
- Migration instructions with rollback procedures.

**Issues:**
1. **No git tags**: Despite 12 versions documented in the CHANGELOG, `git tag -l` returns empty. Tags should match CHANGELOG versions for release traceability.
2. **No patch release notes for 2.3.x series**: Changelog jumps from v2.3.0 to v2.3.1 with minimal detail. The v2.3.x range in the coherence table references "10-module refactor" but patch-level changes are thin.
3. **Self-awarded A+ grades**: Every version from v2.0.0 onward receives A+ or A grades. The TSC framework's own repository scores itself at C_Sigma = 0.238 (FAIL). The cnos grades appear aspirational rather than rigorously measured — there is no evidence of running the formal TSC evaluation pipeline.
4. **v3.0.0 line count claims**: CHANGELOG says "~1,500 lines total" for 6 new modules, but actual measurement shows `cn_runtime.ml` (557) + `cn_json.ml` (310) + `cn_context.ml` (177) + `cn_telegram.ml` (170) + `cn_llm.ml` (154) + `cn_config.ml` (88) = 1,456 lines. This is within rounding tolerance.

### 4.2 Release Process

- CI workflow runs build + test on push to main and PRs.
- Release workflow triggers on `v*` tags, builds cross-platform binaries (Linux x64, macOS x64, macOS ARM64), and creates GitHub releases.
- **No checksums generated** for release binaries.
- **No signing** of release artifacts.
- **No CODEOWNERS file** for review requirements.
- **No dependabot configuration** for CI action updates.
- **opam caching missing** in CI — fresh install every run.

---

## 5. CI/CD Audit

### 5.1 ci.yml

| Step | Status |
|------|--------|
| Checkout | Present |
| OCaml setup (4.14.x) | Present |
| Dependency install | Present |
| Build native binary | Present |
| Run tests (cram + unit) | Present |
| Smoke test (--version, --help) | Present |
| Lint/format check | **Missing** |
| Doc test / spec test | **Missing** (CNOS.md claims "tested by CI") |
| Multi-OS testing | **Missing** (only ubuntu-latest) |
| Dependency caching | **Missing** |

### 5.2 release.yml

| Step | Status |
|------|--------|
| Cross-platform build matrix | Present (Linux, macOS x64, macOS ARM) |
| Tests on all platforms | Present |
| Binary packaging | Present |
| GitHub release creation | Present |
| SHA256 checksums | **Missing** |
| Binary signing | **Missing** |
| Version validation (tag vs cn_lib.ml) | **Missing** |
| Changelog extraction | **Missing** (uses auto-generated notes instead) |

---

## 6. Spec Audit

### 6.1 `spec/system/`

- **CNOS.md**: Claims "Each spec is executable (tested by CI)" with `dune build @doc-test`, but CI only runs `dune runtest`. If these are separate targets, executable specs are not being tested.
- **SYSTEM.md**: Well-written system specification defining the input/output contract, GTD protocol, and security invariants. Matches the v3.0 implementation.
- **PROTOCOL.md**: Duplicates content from `docs/design/PROTOCOL.md` — should be one canonical source.
- **GIT.md**: Defines git conventions (branch naming, commit format). Accurate.
- **HUB.md**: Defines hub directory structure. Accurate.
- **AGENT.md**: Defines agent behavioral contract. Accurate.

### 6.2 `spec/schemas/peers.schema.json`

- Defines JSON schema for peers but the codebase uses `peers.md` (Markdown format parsed by `cn_lib.ml:parse_peers_md`). Schema is unused.
- Schema includes `public_key` field for signature verification — a forward-looking design that is not yet implemented.

---

## 7. Summary of Findings

### Critical (should fix before next release)

| # | Finding | Location | Impact |
|---|---------|----------|--------|
| 1 | Shell injection surface via unquoted `install_dir` in shell commands | `cn_agent.ml:538-540` | Security: environment variable could inject shell commands |
| 2 | No git tags for any release | Repository | Release traceability broken — cannot `git checkout v3.0.0` |
| 3 | `run_setup` replaces entire crontab — `echo ... \| crontab -` destroys existing cron jobs | `cn_system.ml:181` | Data loss: user's existing cron jobs silently deleted |

### High (should fix soon)

| # | Finding | Location | Impact |
|---|---------|----------|--------|
| 4 | ARCHITECTURE.md references non-existent `cn_daemon.ml` | `docs/ARCHITECTURE.md` | Doc-code mismatch confuses new contributors |
| 5 | WHITEPAPER.md claims `peers.json` but code uses `peers.md` | `docs/design/WHITEPAPER.md` | Spec-code mismatch |
| 6 | 731-line god module with mixed concerns | `cn_agent.ml` | Maintainability — auto-update logic interleaved with queue/execution |
| 7 | CI claims to test executable specs but does not run `@doc-test` | `.github/workflows/ci.yml` | Spec claim unverified |
| 8 | `run_weekly` week calculation is wrong — `month / 4 + 1` gives quarters, not ISO weeks | `cn_gtd.ml:211-246` | Weekly reflection files mislabeled and overwritten within quarters |
| 9 | `log_action` is a no-op called dozens of times across every module | `cn_hub.ml:23-27` | All operational logging silently discarded; debugging blind spot |
| 10 | SYSTEM.md vs AGENT.md contradict each other on agent interface (direct file I/O vs CLI commands) | `spec/system/SYSTEM.md`, `spec/system/agent/AGENT.md` | Normative specs give conflicting guidance |

### Medium (should plan to address)

| # | Finding | Location | Impact |
|---|---------|----------|--------|
| 11 | 6 modules with zero test coverage | `cn_system.ml`, `cn_gtd.ml`, `cn_mca.ml`, `cn_hub.ml`, `cn_ffi.ml`, `cn_fmt.ml` | Combined 1,069 LOC untested |
| 12 | No cram tests for `cn agent` modes | `test/cram/` | Critical runtime path untested end-to-end |
| 13 | ~600-700 lines (~12%) dead/deprecated code across codebase | `cn_agent.ml`, `cn_io.ml`, `inbox_lib.ml`, `cn_ffi.ml`, `cn_lib.ml` | Maintenance burden, confusion for contributors |
| 14 | `cn_io.ml` (193 lines) appears entirely superseded by `cn_mail.ml` | `src/transport/cn_io.ml` | Dead module still linked as dependency |
| 15 | Actor FSM not used by the new v3.0 runtime — only deprecated `run_inbound` uses it | `cn_runtime.ml`, `cn_protocol.ml` | Core protocol artifact disconnected from production code path |
| 16 | Parsed CLI flags (`--json`, `--quiet`, `--verbose`) are accepted but do nothing | `cn_lib.ml:419-425` | Silent feature gap — users expect these to work |
| 17 | Duplicated code: `split_status`/`is_retryable` between LLM and Telegram modules; `derive_name`/`starts_with`/`strip_prefix` between cn_lib and inbox_lib | Multiple files | DRY violation, divergence risk |
| 18 | ROADMAP.md outdated with completed items | `ROADMAP.md` | Project direction unclear to potential contributors |
| 19 | TSC grades appear self-awarded without formal evaluation | `CHANGELOG.md` | Quality metric credibility |
| 20 | No opam caching in CI | `.github/workflows/ci.yml` | CI time unnecessarily long |
| 21 | No lint/format enforcement in CI | `.github/workflows/ci.yml` | Style consistency not enforced |
| 22 | Release binaries without checksums or signing | `.github/workflows/release.yml` | Supply-chain verification gap |
| 23 | Hand-constructed JSON in `run_out` meta.json risks injection if values contain quotes | `cn_agent.ml:407-416` | Should use `Cn_json.to_string` |

### Low (nice to have)

| # | Finding | Location | Impact |
|---|---------|----------|--------|
| 24 | `cn_json.ml` does not handle `\uXXXX` escapes | `src/lib/cn_json.ml` | Edge case for unicode Telegram usernames |
| 25 | `Child_process.exec` loses error context | `src/ffi/cn_ffi.ml` | Debugging difficulty |
| 26 | Missing `string_of_sender_event`, `string_of_receiver_event` | `src/protocol/cn_protocol.ml` | Logging/debugging inconsistency |
| 27 | Archived docs lack "SUPERSEDED" banners | `docs/design/_archive/` | Discovery confusion |
| 28 | `spec/system/PROTOCOL.md` duplicates `docs/design/PROTOCOL.md` | `spec/system/` | Maintenance burden |
| 29 | `PLAN.md` is a stale snapshot | Root | Misleading |
| 30 | `cn_ffi.ml:Path.basename_ext` ignores its extension parameter | `src/ffi/cn_ffi.ml:96` | Misleading API — works by accident since all callers pass `.md` |
| 31 | `cn_hub.ml:slugify` truncates before lowercasing — can split multi-byte UTF-8 | `src/cmd/cn_hub.ml:39-58` | Invalid slugs for non-ASCII input |
| 32 | HUB.md vs SYSTEM.md directory structure mismatch (`threads/mail/inbox/` vs `threads/inbox/`) | `spec/system/HUB.md`, `spec/system/SYSTEM.md` | Spec inconsistency |

---

## 8. Recommendations (Priority Order)

1. **Fix `run_setup` crontab replacement** — use `(crontab -l 2>/dev/null; echo "...") | crontab -` to append instead of replace.
2. **Quote `install_dir` in shell commands** — one-line fix, eliminates injection surface.
3. **Create git tags** for all released versions (`v1.0.0` through `v3.0.0`).
4. **Fix `run_weekly` week calculation** — use ISO week numbers instead of `month / 4 + 1`.
5. **Restore or remove `log_action`** — either implement logging or remove the no-op and all call sites.
6. **Fix ARCHITECTURE.md** — replace `cn_daemon.ml` reference with `cn_runtime.ml`.
7. **Reconcile SYSTEM.md vs AGENT.md** — resolve the agent interface contradiction.
8. **Update WHITEPAPER.md** — either migrate code to `peers.json` or update whitepaper to reflect `peers.md` reality.
9. **Remove dead code** — `cn_io.ml` (193 lines, superseded), `inbox_lib.ml` action planning (~150 lines), deprecated functions in `cn_agent.ml` (~230 lines), unused `Http.get`/`Http.post` in `cn_ffi.ml`. Target: remove ~600 lines.
10. **Extract `cn_update.ml`** from `cn_agent.ml` — reduces god module, improves testability.
11. **Either implement `--json`/`--quiet`/`--verbose` flags or remove them from the parser** — currently they are silent no-ops.
12. **Deduplicate shared code** — extract `split_status`/`is_retryable` to shared module; consolidate `derive_name`/string helpers between `cn_lib` and `inbox_lib`.
13. **Add `@doc-test` target to CI** — or remove the claim from CNOS.md.
14. **Add tests for `cn_system.ml`, `cn_gtd.ml`** — these handle user-facing commands.
15. **Use `Cn_json.to_string` for meta.json construction** in `cn_agent.ml:run_out` instead of hand-formatted `Printf.sprintf`.
16. **Add opam caching to CI** — `actions/cache` for `~/.opam`.
17. **Add SHA256 checksums to release workflow**.

---

## 9. Overall Assessment

cnos is a well-engineered OCaml project with disciplined architecture, strong type safety, and unusually thorough documentation for its size. The pure-core/effectful-shell separation is textbook, the FSM design (`cn_protocol.ml`) is the standout module, and the test infrastructure (ppx_expect + cram) is appropriate.

The project shows clear evidence of **evolutionary growth** — the transport layer (`cn_io.ml`, `inbox_lib.ml`) was the original implementation, later superseded by the command layer (`cn_mail.ml`, `cn_agent.ml`). The old layer is still linked but largely unused, contributing to the ~12% dead code figure. A cleanup pass removing the superseded transport code would meaningfully reduce complexity.

**Three areas of concern:**

1. **Correctness bugs**: The crontab replacement in `run_setup` (destroys existing cron jobs) and the wrong weekly calculation in `run_weekly` are real bugs that affect users. The `log_action` no-op means all operational logging is silently discarded.

2. **Breadth over depth in testing**: The protocol layer is exhaustively tested (2.3x test-to-source ratio), but 6 command modules (1,069 combined LOC) have zero unit tests. The actor FSM — a core protocol artifact — is disconnected from the v3.0 runtime path.

3. **Spec-code drift**: The doc-to-code ratio of 2.7:1 is remarkable but creates maintenance burden. SYSTEM.md and AGENT.md contradict each other on the agent interface. HUB.md and SYSTEM.md disagree on directory structure. The whitepaper's `peers.json` never materialized. These are not just cosmetic — they could mislead implementors.

The self-awarded TSC grades in the CHANGELOG are aspirational — applying the actual TSC framework rigorously (which scores itself at C_Sigma = 0.238) would likely produce lower numbers. This audit's grade of B+/A- (0.84) is honest: strong architecture with real gaps in execution details.

For a project at version 3.0.0 with 86 commits and two active contributors, this is solid work with a clear path forward: fix the 3 critical issues, remove the ~600 lines of dead code, reconcile the spec contradictions, and then systematically close the testing gaps.

**Finding count: 3 critical, 7 high, 13 medium, 9 low (32 total).**
